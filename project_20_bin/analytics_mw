#!/usr/bin/env python3
import os, sys, datetime, psycopg2

DATABASE_URL = os.environ.get("DATABASE_URL") or os.environ.get("DATABASE_URI") or ""

def get_conn():
    import re
    m = re.match(r'postgres(?:ql)?://([^:]+):([^@]+)@([^:]+):([0-9]+)/(.+)', DATABASE_URL)
    if not m:
        print("BAD DATABASE_URL:", DATABASE_URL)
        sys.exit(2)
    user, pwd, host, port, db = m.groups()
    return psycopg2.connect(host=host, port=port, dbname=db, user=user, password=pwd)

def create_schema_and_tables(conn):
    cur = conn.cursor()
    cur.execute("CREATE SCHEMA IF NOT EXISTS devices;")
    cur.execute("""
    CREATE TABLE IF NOT EXISTS devices.daily_summary (
      summary_date date NOT NULL,
      device_id text NOT NULL,
      rows_count bigint,
      avg_distance double precision,
      min_distance double precision,
      max_distance double precision,
      avg_voltage double precision,
      last_ts timestamptz,
      updated_at timestamptz DEFAULT now(),
      PRIMARY KEY (summary_date, device_id)
    );""")
    conn.commit()
    cur.close()

def insert_sample(conn):
    cur = conn.cursor()
    today = datetime.date.today()
    now = datetime.datetime.now()
    sql = """
    INSERT INTO devices.daily_summary
      (summary_date, device_id, rows_count, avg_distance, min_distance, max_distance, avg_voltage, last_ts)
    VALUES (%s,%s,%s,%s,%s,%s,%s,%s)
    ON CONFLICT (summary_date, device_id) DO UPDATE
      SET rows_count = EXCLUDED.rows_count,
          avg_distance = EXCLUDED.avg_distance,
          min_distance = EXCLUDED.min_distance,
          max_distance = EXCLUDED.max_distance,
          avg_voltage = EXCLUDED.avg_voltage,
          last_ts = EXCLUDED.last_ts,
          updated_at = now();
    """
    params = (today, "sample_device", 10, 12.34, 1.2, 50.0, 3.7, now)
    cur.execute(sql, params)
    conn.commit()
    cur.close()

def main():
    global DATABASE_URL
    # allow override via env
    if not DATABASE_URL:
        DATABASE_URL = os.environ.get("DATABASE_URL")
    if not DATABASE_URL:
        print("Please set DATABASE_URL (postgresql://user:pwd@host:port/db)")
        sys.exit(1)
    conn = get_conn()
    create_schema_and_tables(conn)
    insert_sample(conn)
    conn.close()
    print("daily done")

if __name__ == "__main__":
    main()
